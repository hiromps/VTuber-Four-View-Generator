<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTuberå››é¢å›³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ - AIç«‹ã¡çµµç”Ÿæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .token-display {
            background: rgba(139, 92, 246, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.4);
            font-weight: 600;
        }

        .token-count {
            color: #fbbf24;
            font-size: 1.2rem;
        }

        button {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.05);
        }

        .upload-zone:hover {
            border-color: #a855f7;
            background: rgba(139, 92, 246, 0.1);
        }

        .upload-zone.dragover {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: rgba(139, 92, 246, 0.6);
            margin-bottom: 15px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 20px;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 640px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-item {
            position: relative;
            aspect-ratio: 1;
            background: rgba(55, 65, 81, 0.5);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-label {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .placeholder {
            color: rgba(156, 163, 175, 0.5);
            font-size: 1rem;
        }

        .loading-spinner {
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-top: 4px solid #a855f7;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #a855f7;
        }

        input {
            width: 100%;
            padding: 12px;
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        input:focus {
            outline: none;
            border-color: #a855f7;
        }

        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            margin-top: 10px;
        }

        .api-key-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
        }

        .api-key-section h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .cost-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .cost-info strong {
            color: #fbbf24;
            font-size: 1.2rem;
        }

        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #a855f7;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
        <div class="container">
            <div class="header-content">
                <h1>ğŸ¨ VTuberå››é¢å›³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
                <div class="auth-section">
                    <div class="token-display" id="tokenDisplay">
                        ãƒˆãƒ¼ã‚¯ãƒ³: <span class="token-count" id="tokenCount">5</span>
                    </div>
                    <button onclick="showApiKeyModal()">APIè¨­å®š</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="container">
        <div class="main-content">
            <!-- å·¦å´: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="card">
                <h2 class="section-title">1. ç«‹ã¡çµµã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“¤</div>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <p style="font-size: 0.85rem; color: rgba(156, 163, 175, 0.7); margin-top: 10px;">
                        PNG, JPEG, WEBPå¯¾å¿œ
                    </p>
                </div>
                <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" style="display: none;" onchange="handleFileSelect(event)">
                <img id="previewImage" class="preview-image" style="display: none;">

                <h2 class="section-title" style="margin-top: 30px;">2. ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆä»»æ„ï¼‰</h2>
                <textarea
                    id="additionalPrompt"
                    placeholder="è¿½åŠ ã®æŒ‡ç¤ºã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šã€Œçœ¼é¡ã‚’ã‹ã‘ã¦ã„ã‚‹ã€ã€Œé«ªã®è‰²ã‚’é’ã«ã€ãªã©ï¼‰"
                ></textarea>
                <div class="info-box">
                    ğŸ’¡ è¿½åŠ æŒ‡ç¤ºã§ç´°ã‹ã„èª¿æ•´ãŒå¯èƒ½ã§ã™
                </div>

                <h2 class="section-title" style="margin-top: 30px;">3. ç”Ÿæˆ</h2>
                <div class="cost-info">
                    ç”Ÿæˆã‚³ã‚¹ãƒˆ: <strong>4ãƒˆãƒ¼ã‚¯ãƒ³</strong>
                </div>
                <button class="generate-btn" id="generateBtn" onclick="generateFourViews()" disabled>
                    å››é¢å›³ã‚’ç”Ÿæˆ
                </button>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>

            <!-- å³å´: çµæœè¡¨ç¤º -->
            <div class="card">
                <h2 class="section-title">ç”Ÿæˆçµæœ</h2>
                <div class="results-grid">
                    <div>
                        <div class="result-item" id="frontResult">
                            <div class="placeholder">æ­£é¢</div>
                        </div>
                        <div class="result-label">Front (æ­£é¢)</div>
                    </div>
                    <div>
                        <div class="result-item" id="backResult">
                            <div class="placeholder">èƒŒé¢</div>
                        </div>
                        <div class="result-label">Back (èƒŒé¢)</div>
                    </div>
                    <div>
                        <div class="result-item" id="leftResult">
                            <div class="placeholder">å·¦å´é¢</div>
                        </div>
                        <div class="result-label">Left (å·¦å´é¢)</div>
                    </div>
                    <div>
                        <div class="result-item" id="rightResult">
                            <div class="placeholder">å³å´é¢</div>
                        </div>
                        <div class="result-label">Right (å³å´é¢)</div>
                    </div>
                </div>
                <button class="download-btn" id="downloadBtn" onclick="downloadAllImages()" style="display: none; width: 100%;">
                    å…¨ã¦ã®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>

        <!-- API Keyè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card api-key-section">
            <h3>ğŸ”‘ Google Gemini APIè¨­å®š</h3>
            <p style="font-size: 0.9rem; color: rgba(156, 163, 175, 0.9); margin-bottom: 15px;">
                ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Google Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #60a5fa;">ã“ã¡ã‚‰</a>ã‹ã‚‰ç„¡æ–™ã§å–å¾—ã§ãã¾ã™ã€‚
            </p>
            <div class="info-box">
                âš ï¸ APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
            </div>
        </div>
    </div>

    <!-- API Keyè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <h2 class="modal-title">Google Gemini APIè¨­å®š</h2>
            <p style="margin-bottom: 20px; color: rgba(156, 163, 175, 0.9);">
                APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #60a5fa;">Google AI Studio</a>ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚
            </p>
            <input
                type="text"
                id="apiKeyInput"
                placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›"
            >
            <div style="display: flex; gap: 10px;">
                <button onclick="saveApiKey()" style="flex: 1;">ä¿å­˜</button>
                <button onclick="closeApiKeyModal()" style="flex: 1; background: #4b5563;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let uploadedImage = null;
        let generatedImages = {
            front: null,
            back: null,
            left: null,
            right: null
        };

        // åˆæœŸåŒ–
        function init() {
            loadTokens();
            loadApiKey();
            setupDragAndDrop();

            // API KeyãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                setTimeout(() => showApiKeyModal(), 500);
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®è¨­å®š
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');

                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFile(file);
                }
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = {
                    data: e.target.result,
                    mimeType: file.type
                };

                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';

                document.getElementById('generateBtn').disabled = false;
                showError('');
            };
            reader.readAsDataURL(file);
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
        function loadTokens() {
            const tokens = localStorage.getItem('tokens') || '5';
            document.getElementById('tokenCount').textContent = tokens;
        }

        function updateTokens(amount) {
            let tokens = parseInt(localStorage.getItem('tokens') || '5');
            tokens += amount;
            localStorage.setItem('tokens', tokens.toString());
            loadTokens();
        }

        function getTokens() {
            return parseInt(localStorage.getItem('tokens') || '5');
        }

        // API Keyç®¡ç†
        function loadApiKey() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }
        }

        function showApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('active');
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('active');
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                closeApiKeyModal();
                showError('');
            } else {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (message) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div class="loading-spinner"></div>';
        }

        function hideLoading(elementId, content) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
        }

        // å››é¢å›³ç”Ÿæˆ
        async function generateFourViews() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showError('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å³ä¸Šã®ã€ŒAPIè¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                showApiKeyModal();
                return;
            }

            if (!uploadedImage) {
                showError('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (getTokens() < 4) {
                showError('ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ï¼ˆå¿…è¦: 4ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            showError('');

            const views = ['front', 'back', 'left', 'right'];
            const additionalPrompt = document.getElementById('additionalPrompt').value;

            try {
                // å„ãƒ“ãƒ¥ãƒ¼ã‚’é †ç•ªã«ç”Ÿæˆ
                for (const view of views) {
                    showLoading(`${view}Result`);

                    const imageUrl = await generateSingleView(view, additionalPrompt, apiKey);
                    generatedImages[view] = imageUrl;

                    hideLoading(`${view}Result`, `<img src="${imageUrl}" alt="${view} view">`);
                }

                // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸›ã‚‰ã™
                updateTokens(-4);

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('downloadBtn').style.display = 'block';

            } catch (error) {
                console.error('Generation error:', error);
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);

                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                views.forEach(view => {
                    if (!generatedImages[view]) {
                        hideLoading(`${view}Result`, `<div class="placeholder">${getViewLabel(view)}</div>`);
                    }
                });
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'å››é¢å›³ã‚’ç”Ÿæˆ';
            }
        }

        // å˜ä¸€ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆ
        async function generateSingleView(view, additionalPrompt, apiKey) {
            const viewInstructions = {
                front: 'æ­£é¢ã‹ã‚‰è¦‹ãŸæ§˜å­ï¼ˆT-poseï¼‰',
                back: 'å¾Œã‚ã‹ã‚‰è¦‹ãŸæ§˜å­ï¼ˆèƒŒä¸­å´ï¼‰',
                left: 'å·¦å´é¢ã‹ã‚‰è¦‹ãŸæ§˜å­',
                right: 'å³å´é¢ã‹ã‚‰è¦‹ãŸæ§˜å­'
            };

            const criticalInstructions = additionalPrompt
                ? `CRITICAL REQUIREMENT - YOU MUST APPLY THESE MODIFICATIONS: ${additionalPrompt}. `
                : '';

            const commonPrompt = "Using the provided image of a character's front view, generate a high-quality, clean illustration of the character's";
            const framingPrompt = "IMPORTANT: The ENTIRE character must be FULLY VISIBLE within the frame from head to toe. DO NOT crop any part of the character. Leave appropriate margin space around the character. The full body must fit completely within the image boundaries.";
            const stylePrompt = "in the exact same art style, color palette, and character details. The character should be in a neutral T-pose. The background must be a solid, neutral gray (#808080).";

            let viewPrompt;
            switch (view) {
                case 'front':
                    viewPrompt = `${criticalInstructions}${commonPrompt} front view, but standardized in a T-pose ${stylePrompt} ${framingPrompt}`;
                    break;
                case 'back':
                    viewPrompt = `${criticalInstructions}${commonPrompt} back view ${stylePrompt} ${framingPrompt}`;
                    break;
                case 'left':
                    viewPrompt = `${criticalInstructions}${commonPrompt} left side view ${stylePrompt} ${framingPrompt}`;
                    break;
                case 'right':
                    viewPrompt = `${criticalInstructions}${commonPrompt} right side view ${stylePrompt} ${framingPrompt}`;
                    break;
            }

            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Base64éƒ¨åˆ†ã‚’æŠ½å‡º
            const base64Data = uploadedImage.data.split(',')[1];

            // Google Gemini 2.5 Flash Image APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            // æ³¨æ„: ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã™å ´åˆã€CORSåˆ¶é™ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    inlineData: {
                                        mimeType: uploadedImage.mimeType,
                                        data: base64Data
                                    }
                                },
                                {
                                    text: viewPrompt
                                }
                            ]
                        }],
                        generationConfig: {
                            responseModalities: ['IMAGE'],
                            temperature: 0.4,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error?.message || 'APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const parts = data.candidates?.[0]?.content?.parts || [];
                for (const part of parts) {
                    if (part.inlineData) {
                        console.log(`[Success] ${view} view generated`);
                        return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                    }
                }

                throw new Error('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

            } catch (error) {
                console.error(`Error generating ${view} view:`, error);

                // CORS ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    throw new Error(`CORSåˆ¶é™ã®ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥APIã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚\n\næ¨å¥¨: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€Youwareã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚\n\nãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`);
                }

                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’è¿”ã™
                console.warn(`Falling back to placeholder for ${view} view`);
                return generatePlaceholderImage(view, viewInstructions[view]);
            }
        }

        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒç”Ÿæˆï¼ˆé–‹ç™ºç”¨ãƒ»ãƒ‡ãƒ¢ç”¨ï¼‰
        function generatePlaceholderImage(view, description) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 768;
            const ctx = canvas.getContext('2d');

            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 512, 768);
            gradient.addColorStop(0, '#8b5cf6');
            gradient.addColorStop(1, '#ec4899');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 512, 768);

            // åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, 512, 768);

            // ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
            ctx.fillStyle = 'white';
            ctx.font = 'bold 36px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰', 256, 200);

            // ãƒ“ãƒ¥ãƒ¼å
            ctx.font = 'bold 28px sans-serif';
            const viewLabels = {
                front: 'Front (æ­£é¢)',
                back: 'Back (èƒŒé¢)',
                left: 'Left (å·¦å´é¢)',
                right: 'Right (å³å´é¢)'
            };
            ctx.fillText(viewLabels[view] || view, 256, 280);

            // èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ
            ctx.font = '18px sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            const lines = [
                'å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã«ã¯',
                'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒ',
                'å¿…è¦ã§ã™',
                '',
                'ã¾ãŸã¯',
                '',
                'Youwareã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰',
                'æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„'
            ];

            let y = 350;
            lines.forEach(line => {
                ctx.fillText(line, 256, y);
                y += 30;
            });

            // ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç°¡æ˜“çš„ãªå›³å½¢ï¼‰
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(256, 650, 40, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(256, 610);
            ctx.lineTo(256, 650);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(256, 600, 5, 0, Math.PI * 2);
            ctx.fill();

            return canvas.toDataURL('image/png');
        }

        // ãƒ“ãƒ¥ãƒ¼ãƒ©ãƒ™ãƒ«å–å¾—
        function getViewLabel(view) {
            const labels = {
                front: 'æ­£é¢',
                back: 'èƒŒé¢',
                left: 'å·¦å´é¢',
                right: 'å³å´é¢'
            };
            return labels[view] || view;
        }

        // å…¨ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadAllImages() {
            Object.entries(generatedImages).forEach(([view, imageUrl]) => {
                if (imageUrl) {
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = `vtuber-${view}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
