# Stripe Webhook è¨­å®šã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€VTuber Four-View Generatorã®ãƒˆãƒ¼ã‚¯ãƒ³è³¼å…¥æ©Ÿèƒ½ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã«å¿…è¦ãªStripe Webhookã®è¨­å®šæ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ](#webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
3. [Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¨­å®š](#stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¨­å®š)
4. [ç’°å¢ƒå¤‰æ•°ã®è¨­å®š](#ç’°å¢ƒå¤‰æ•°ã®è¨­å®š)
5. [ãƒ†ã‚¹ãƒˆæ–¹æ³•](#ãƒ†ã‚¹ãƒˆæ–¹æ³•)
6. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### Webhookã®å½¹å‰²

Stripe Webhookã¯ã€æ±ºæ¸ˆãŒå®Œäº†ã—ãŸéš›ã«ã‚µãƒ¼ãƒãƒ¼ã«é€šçŸ¥ã‚’é€ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é«˜ã‚’è‡ªå‹•çš„ã«æ›´æ–°ã—ã¾ã™ã€‚

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒStripeæ±ºæ¸ˆã‚’å®Œäº†
2. StripeãŒwebhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«`checkout.session.completed`ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
3. ã‚µãƒ¼ãƒãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å–å¾—
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é«˜ã‚’æ›´æ–°
5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒãƒ¼ãƒªãƒ³ã‚°æ©Ÿæ§‹ãŒæ›´æ–°ã‚’æ¤œçŸ¥ã—ã¦è¡¨ç¤º

### å®Ÿè£…çŠ¶æ³

âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿:**
- Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `/app/api/stripe/webhook/route.ts`
- ãƒˆãƒ¼ã‚¯ãƒ³è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯: `/lib/tokens.ts`
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°æ©Ÿæ§‹: `/app/page.tsx`

ğŸ”§ **è¨­å®šãŒå¿…è¦:**
- Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®webhookç™»éŒ²
- ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

---

## Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL

**æœ¬ç•ªç’°å¢ƒ:**
```
https://your-domain.vercel.app/api/stripe/webhook
```

ä¾‹: `https://vtuber-four-view-generator.vercel.app/api/stripe/webhook`

**ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ:**
```
https://your-domain.ngrok.io/api/stripe/webhook
```

> **æ³¨æ„:** ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã¯ã€Stripe CLIã¾ãŸã¯ngrokã‚’ä½¿ç”¨ã—ã¦webhookã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

### å®Ÿè£…ã®è©³ç´°

**ãƒ•ã‚¡ã‚¤ãƒ«:** `app/api/stripe/webhook/route.ts`

**å‡¦ç†å†…å®¹:**
1. Stripeç½²åã‚’æ¤œè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
2. `checkout.session.completed`ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰`userId`ã¨`tokens`ã‚’å–å¾—
4. `addTokens()`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
5. å‡¦ç†çµæœã‚’ãƒ­ã‚°ã«è¨˜éŒ²

**ç›£è¦–ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ:**
- `checkout.session.completed` - æ±ºæ¸ˆå®Œäº†æ™‚

---

## Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¨­å®š

### ã‚¹ãƒ†ãƒƒãƒ—1: Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹

1. [Stripe Dashboard](https://dashboard.stripe.com/) ã«ãƒ­ã‚°ã‚¤ãƒ³
2. æ­£ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ†ã‚¹ãƒˆ/æœ¬ç•ªï¼‰ã‚’é¸æŠ

### ã‚¹ãƒ†ãƒƒãƒ—2: Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 

#### ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š

1. **é–‹ç™ºè€… > Webhooks** ã«ç§»å‹•
2. å³ä¸Šã® **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤º** ã‚’ç¢ºèª
3. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ** ã‚’ã‚¯ãƒªãƒƒã‚¯

4. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›:
   - **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL**:
     ```
     https://your-vercel-app.vercel.app/api/stripe/webhook
     ```
   - **èª¬æ˜**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰: `VTuber ãƒˆãƒ¼ã‚¯ãƒ³è³¼å…¥ Webhook`
   - **ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ**: ä¸‹è¨˜å‚ç…§

5. **ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ**:
   - ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - æ¤œç´¢ãƒãƒ¼ã§ `checkout.session.completed` ã‚’æ¤œç´¢
   - âœ… `checkout.session.completed` ã«ãƒã‚§ãƒƒã‚¯
   - ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

6. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ** ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜

#### æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š

1. å³ä¸Šã§ **æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤º** ã«åˆ‡ã‚Šæ›¿ãˆ
2. ä¸Šè¨˜ã¨åŒã˜æ‰‹é †ã‚’ç¹°ã‚Šè¿”ã™
   - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã¯æœ¬ç•ªç”¨ã®Vercel URLã‚’ä½¿ç”¨
   - åŒã˜ã `checkout.session.completed` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ

### ã‚¹ãƒ†ãƒƒãƒ—3: Webhookç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã¨ã€**ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆSigning Secretï¼‰**ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ãƒšãƒ¼ã‚¸ã§ **ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¡¨ç¤º** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. `whsec_...` ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒ¼

**å½¢å¼:**
```
whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

ã“ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚

---

## ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

### å¿…è¦ãªç’°å¢ƒå¤‰æ•°

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã§ã™ï¼š

```env
# Stripeè¨­å®š
STRIPE_SECRET_KEY=sk_test_xxxxx...
STRIPE_WEBHOOK_SECRET=whsec_xxxxx...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx...
```

### Vercelã§ã®è¨­å®šæ–¹æ³•

1. [Vercel Dashboard](https://vercel.com/dashboard) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. **Settings > Environment Variables** ã«ç§»å‹•

#### ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å¤‰æ•°

4. ä»¥ä¸‹ã®å¤‰æ•°ã‚’è¿½åŠ ï¼ˆ`Preview` ã¨ `Development` ã«ãƒã‚§ãƒƒã‚¯ï¼‰:

   **å¤‰æ•°å:** `STRIPE_WEBHOOK_SECRET`
   **å€¤:** `whsec_...` ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰

#### æœ¬ç•ªç’°å¢ƒã®å¤‰æ•°

5. æœ¬ç•ªç”¨ã®ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¿½åŠ ï¼ˆ`Production` ã«ãƒã‚§ãƒƒã‚¯ï¼‰:

   **å¤‰æ•°å:** `STRIPE_WEBHOOK_SECRET`
   **å€¤:** `whsec_...` ï¼ˆæœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã®ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰

6. **Save** ã‚’ã‚¯ãƒªãƒƒã‚¯

7. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤**
   - Deploymentsã‚¿ãƒ–ã«ç§»å‹•
   - æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å³å´ `...` ã‚’ã‚¯ãƒªãƒƒã‚¯
   - **Redeploy** ã‚’é¸æŠ

> **é‡è¦:** ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ãƒ»å¤‰æ›´ã—ãŸå¾Œã¯ã€å¿…ãšå†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™ã€‚

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆ.env.localï¼‰

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã¯ `.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®š:

```env
# Stripe - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
STRIPE_SECRET_KEY=sk_test_51NiuICDE82UMk94O...
STRIPE_WEBHOOK_SECRET=whsec_xxxxx... # Stripe CLIã¾ãŸã¯ngrokç”¨
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51NiuICDE82UMk94O...

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...

# ãã®ä»–
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## ãƒ†ã‚¹ãƒˆæ–¹æ³•

### æ–¹æ³•1: Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆé€ä¿¡

1. **é–‹ç™ºè€… > Webhooks** ã«ç§»å‹•
2. è¨­å®šã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
3. å³ä¸Šã® **ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—: `checkout.session.completed` ã‚’é¸æŠ
5. **ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡** ã‚’ã‚¯ãƒªãƒƒã‚¯

**ç¢ºèªé …ç›®:**
- âœ… Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã€ŒæˆåŠŸã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… Vercelã®ãƒ­ã‚°ã«å‡¦ç†ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹

### æ–¹æ³•2: å®Ÿéš›ã®æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ

#### æº–å‚™
1. ã‚¢ãƒ—ãƒªã«ãƒ­ã‚°ã‚¤ãƒ³
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’é–‹ã
3. **Console** ã‚¿ãƒ–ã‚’é–‹ã

#### ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆã‚’å®Ÿè¡Œ

1. ãƒˆãƒ¼ã‚¯ãƒ³è³¼å…¥ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. Stripeãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒšãƒ¼ã‚¸ã§ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å…¥åŠ›:

   **ã‚«ãƒ¼ãƒ‰ç•ªå·:** `4242 4242 4242 4242`
   **æœ‰åŠ¹æœŸé™:** ä»»æ„ã®æœªæ¥æ—¥ä»˜ï¼ˆä¾‹: `12/25`ï¼‰
   **CVC:** ä»»æ„ã®3æ¡ï¼ˆä¾‹: `123`ï¼‰
   **éƒµä¾¿ç•ªå·:** ä»»æ„ï¼ˆä¾‹: `12345`ï¼‰

3. **æ”¯æ‰•ã†** ã‚’ã‚¯ãƒªãƒƒã‚¯

#### çµæœã‚’ç¢ºèª

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ï¼š

```
âœ… æˆåŠŸæ™‚ã®ãƒ­ã‚°:
Payment successful! Starting token polling...
Initial tokens: 100
[Token Polling] Attempt 1/10
[Token Polling] Current: 100, Initial: 100
[Token Polling] Attempt 2/10
[Token Polling] Current: 150, Initial: 100
âœ… [Token Polling] Tokens updated successfully!
```

**ç¢ºèªé …ç›®:**
- âœ… ã€ŒPayment successful!ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… 2-5ç§’å¾Œã«ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é«˜ãŒå¢—åŠ ã™ã‚‹
- âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«æˆåŠŸãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### æ–¹æ³•3: Stripe CLIã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰

Stripe CLIã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§Webhookã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**Mac:**
```bash
brew install stripe/stripe-cli/stripe
```

**Windows:**
```bash
scoop bucket add stripe https://github.com/stripe/scoop-stripe-cli.git
scoop install stripe
```

**Linux:**
```bash
wget -qO- https://github.com/stripe/stripe-cli/releases/latest/download/stripe_*_linux_x86_64.tar.gz | tar xz
```

#### ä½¿ç”¨æ–¹æ³•

1. **Stripeã«ãƒ­ã‚°ã‚¤ãƒ³:**
   ```bash
   stripe login
   ```

2. **Webhookãƒªã‚¹ãƒŠãƒ¼ã‚’èµ·å‹•:**
   ```bash
   stripe listen --forward-to localhost:3000/api/stripe/webhook
   ```

   è¡¨ç¤ºã•ã‚Œã‚‹ `whsec_...` ã‚’ `.env.local` ã® `STRIPE_WEBHOOK_SECRET` ã«è¨­å®š

3. **é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•:**
   ```bash
   npm run dev
   ```

4. **ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡:**
   ```bash
   stripe trigger checkout.session.completed
   ```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¢—ãˆãªã„

**åŸå› ã¨è§£æ±ºç­–:**

#### 1. Webhookç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæœªè¨­å®šã¾ãŸã¯é–“é•ã£ã¦ã„ã‚‹

**ç¢ºèªæ–¹æ³•:**
- Vercelã® Environment Variables ã§ `STRIPE_WEBHOOK_SECRET` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰/æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§æ­£ã—ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèª

**è§£æ±ºç­–:**
1. Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Webhooks > ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè©³ç´° > ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¡¨ç¤º
2. Vercelã§ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

#### 2. Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•:**
- Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Webhooks ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆ`/api/stripe/webhook`ï¼‰

**è§£æ±ºç­–:**
- ä¸Šè¨˜ã®ã€ŒStripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®è¨­å®šã€ã«å¾“ã£ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 

#### 3. Webhookã‚¤ãƒ™ãƒ³ãƒˆãŒå±Šã„ã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•:**
- Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Webhooks > ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ > ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’ç¢ºèª
- å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆèµ¤è‰²ï¼‰ã«ãªã£ã¦ã„ãªã„ã‹ç¢ºèª

**è§£æ±ºç­–:**
- ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã§å¤±æ•—ã®è©³ç´°ã‚’ç¢ºèª
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹ç¢ºèªï¼ˆHTTPSãŒå¿…è¦ï¼‰
- Vercelã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

#### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¨©é™ã®å•é¡Œ

**ç¢ºèªæ–¹æ³•:**
- Vercelã®ãƒ­ã‚°ã«ã€Œpermission deniedã€ã‚„ã€ŒRLS policyã€ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª

**è§£æ±ºç­–:**
- Supabase admin client ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆ`lib/tokens.ts`ï¼‰
- `SUPABASE_SERVICE_ROLE_KEY` ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### å•é¡Œ: WebhookãŒç½²åæ¤œè¨¼ã§å¤±æ•—ã™ã‚‹

**ç—‡çŠ¶:**
- Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€Œ400 Bad Requestã€ã‚¨ãƒ©ãƒ¼
- Vercelãƒ­ã‚°ã«ã€ŒInvalid signatureã€ã‚¨ãƒ©ãƒ¼

**è§£æ±ºç­–:**
1. æ­£ã—ã„ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ç¢ºèª
2. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒæ­£ç¢ºã‹ç¢ºèªï¼ˆæœ«å°¾ã® `/` ã«æ³¨æ„ï¼‰
3. ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°å¾Œã€å¿…ãšå†ãƒ‡ãƒ—ãƒ­ã‚¤

### å•é¡Œ: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§WebhookãŒå‹•ä½œã—ãªã„

**è§£æ±ºç­–:**

**æ–¹æ³•1: Stripe CLIã‚’ä½¿ç”¨**
```bash
stripe listen --forward-to localhost:3000/api/stripe/webhook
```

**æ–¹æ³•2: ngrokã‚’ä½¿ç”¨**
```bash
ngrok http 3000
```
è¡¨ç¤ºã•ã‚ŒãŸHTTPS URLã‚’ä½¿ç”¨ã—ã¦Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç™»éŒ²

---

## Webhookã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®ç¢ºèª

### Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

1. **é–‹ç™ºè€… > Webhooks** ã«ç§»å‹•
2. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
3. **ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´** ã‚¿ãƒ–ã‚’é¸æŠ

å„ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ï¼š
- âœ… ç·‘è‰²ã®ãƒã‚§ãƒƒã‚¯: æˆåŠŸ
- ğŸ”´ èµ¤è‰²ã®X: å¤±æ•—
- â±ï¸ ã‚°ãƒ¬ãƒ¼: å†è©¦è¡Œä¸­

å¤±æ•—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### Vercelãƒ­ã‚°

1. Vercel Dashboard > ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ > **Functions** ã‚¿ãƒ–
2. `/api/stripe/webhook` é–¢æ•°ã‚’é¸æŠ
3. ãƒ­ã‚°ã‚’ç¢ºèª

**æˆåŠŸæ™‚ã®ãƒ­ã‚°ä¾‹:**
```
Successfully added 50 tokens to user abc123. New balance: 150
```

**å¤±æ•—æ™‚ã®ãƒ­ã‚°ä¾‹:**
```
Webhook signature verification failed: Error message...
Failed to add tokens: Error message...
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ç½²åæ¤œè¨¼ã‚’å¿…ãšå®Ÿè£…

Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã¯ã€å¿…ãšStripeç½²åã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰ã€‚

```typescript
event = stripe.webhooks.constructEvent(
  body,
  signature,
  process.env.STRIPE_WEBHOOK_SECRET!
)
```

### 2. ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å®‰å…¨ã«ç®¡ç†

- âŒ ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥è¨˜è¿°ã—ãªã„
- âŒ GitHubã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
- âœ… ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
- âœ… `.env.local` ã‚’ `.gitignore` ã«è¿½åŠ 

### 3. HTTPSå¿…é ˆ

- Stripe Webhookã¯ **HTTPS** ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã®ã¿é€ä¿¡ã•ã‚Œã¾ã™
- Vercelã¯è‡ªå‹•çš„ã«HTTPSã‚’æä¾›ï¼ˆè¨­å®šä¸è¦ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã¯Stripe CLIã¾ãŸã¯ngrokã‚’ä½¿ç”¨

### 4. ã¹ãç­‰æ€§ã®ç¢ºä¿

åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒè¤‡æ•°å›é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã¹ãç­‰æ€§ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ `stripe_session_id` ã‚’ä½¿ç”¨ã—ã¦é‡è¤‡ã‚’é˜²ã„ã§ã„ã¾ã™ï¼ˆ`transactions` ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ï¼‰ã€‚

---

## ãƒªã‚½ãƒ¼ã‚¹

- [Stripe Webhooks Documentation](https://stripe.com/docs/webhooks)
- [Stripe CLI Documentation](https://stripe.com/docs/stripe-cli)
- [Stripe Testing Guide](https://stripe.com/docs/testing)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)

---

## ã‚µãƒãƒ¼ãƒˆ

è³ªå•ã‚„å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Issuesã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å ±å‘Šã—ã¦ãã ã•ã„ã€‚

---

Made with â¤ï¸ for VTuber creators
